# CAN201 2025年
# 简单传输与交换协议（STEP）v1.2
## 1. 引言
简单传输与交换协议（Simple Transfer and Exchange Protocol，简称STEP）是一种无状态、应用层的请求/响应协议，它定义了一种简单的数据和文件交换方式。  
STEP是基于TCP的协议，可确保可靠的数据传输。JavaScript对象表示法（JSON，JavaScript Object Notation）被用作唯一的数据表示格式，该格式简洁且具备人类可读性。  
STEP服务器提供数据与文件的上传、存储、下载及删除服务。相应的客户端需先获得授权，而后方可操作服务器上的公共或私有数据与文件。


## 2. 术语与核心概念
### a）连接、客户端与服务器
STEP是一种客户端/服务器（C/S）协议，运行在可靠的传输层（TCP）连接之上[1,2]。服务器监听的端口必须为1379，因此，建立连接时需同时使用服务器的IP地址和该端口（1379）。连接会保持活跃状态，直至客户端关闭连接。  
STEP客户端是指为发送一个或多个连续STEP请求而与服务器建立连接的程序；STEP服务器则是指接受连接，并通过发送响应来处理STEP请求的程序。

### b）消息
消息通过TCP连接进行交换。客户端发送的请求消息中包含“operation”（操作）、“direction”（方向）及其他必选字段；服务器通过发送响应消息来响应请求，该响应消息中同样包含“operation”（操作）和“direction”（方向）字段。响应消息与请求消息采用相同的格式。  
详细信息将在第3部分中阐述。


## 3. 消息
为简化STEP消息的定义，请求消息与响应消息采用相同的格式和定义，部分保留字段用于指示通信方向。

### 格式
消息由三部分组成：JSON数据部分长度（二进制，必选）、二进制数据部分长度（二进制，必选）、JSON数据（文本，必选）以及文件部分（二进制，可选）。  
前4个字节（用N表示）用于表示JSON数据的长度，这意味着后续JSON数据的最大长度可为2的32次方。  
接下来的4个字节（用M表示）用于表示二进制数据的长度，这意味着后续二进制数据的最大长度可为2的32次方。  
再接下来的N个字节用于表示JSON数据，由于这些数据是基于文本的，需按照JSON规则对其进行解码和解析。  
二进制文件数据（文件/数据块）将附加在消息的末尾。

| 字段 | 说明 |
| ---- | ---- |
| 32位 | - |
| JSON数据部分长度 | 二进制、无符号整数、32位，取值范围2~2的32次方 |
| 二进制文件部分长度 | 二进制、无符号整数、32位，取值范围2~2的32次方 |
| JSON数据部分 | 文本（编码为二进制），示例：<br>“type”: "FILE", "operation": "SAVE",<br>“direction”: "REQUEST", "size": 1024 |
| 二进制文件部分 | 二进制、可选，示例：<br>01001001001001001010010000101011 01001001001001001011010000101011 |

**图1 STEP消息格式**

### b）JSON部分的保留字段
1. **type**：[FILE（文件）、DATA（数据）、AUTH（授权）]  
   该字段的取值可为FILE（文件）和DATA（数据）。

2. **operation**：[SAVE（保存）、DELETE（删除）、GET（获取）、UPLOAD（上传）、DOWNLOAD（下载）、BYE（断开连接）、LOGIN（登录）]  
   - 用于授权时，operation的取值可为LOGIN（登录），此时“type”必须为“AUTH”（授权）。其中，“username”（用户名）为用户的学生ID（字符串类型），“password”（密码）为md5（学生ID）加密后的结果。服务器的响应中会包含“token”（令牌）。  
   - 针对DATA（数据）类型，operation的取值可为SAVE（保存）、DELETE（删除）和GET（获取）：  
     - SAVE（保存）：保存数据，服务器会回复“key”（密钥）。客户端也可通过保留字段“key”指定密钥；若未指定，服务器会回复一个随机密钥。密钥可为任意未被使用的字符串；若该密钥已被使用，服务器会回复带有特定代码的错误信息。  
     - GET（获取）：通过密钥（key）获取数据。  
     - DELETE（删除）：通过密钥（key）删除数据。  
   - 针对FILE（文件）类型，operation的取值可为SAVE（保存）、DELETE（删除）、GET（获取）、UPLOAD（上传）和DOWNLOAD（下载）：  
     - SAVE（保存）：发起文件存储请求，需包含文件的“key”（密钥）和“size”（大小）。密钥可由客户端定义；若未定义，服务器会回复一个随机密钥。服务器还会回复文件上传方案，其中包含“key”（密钥）、“block_size”（块大小）和“total_block”（总块数）。对于文件，密钥可为带扩展名的文件名（例如foo_bar.jpg），且需为任意未被使用的字符串；若该密钥已被使用，服务器会回复带有特定代码的错误信息。  
     - DELETE（删除）：通过密钥（key）删除文件。  
     - GET（获取）：通过密钥（key）发起文件下载请求，服务器会回复文件下载方案，其中包含“key”（密钥）、“size”（文件总大小）、“block_size”（块大小）、“total_block”（总块数）以及文件的“md5”（哈希值）。  
     - UPLOAD（上传）：通过“key”（密钥）和“block_index”（块索引）上传文件块或完整文件。当服务器收到完整文件后，会向客户端回复“md5”（哈希值），以验证文件完整性。  
     - DOWNLOAD（下载）：通过“key”（密钥）和“block_index”（块索引）下载文件块或完整文件，服务器会回复二进制文件块。

3. **direction**（方向）：[REQUEST（请求）、RESPONSE（响应）]

4. **status**（状态）：[200、400及以上]  
   详细说明将在第4部分中阐述。

5. **md5**：文件的md5哈希值。

6. **size**（大小）：取值范围1~4294967296，代表文件大小或块大小……

7. **block_index**（块索引）：取值范围0~N-1（其中N为总块数）

8. **block_size**（块大小）：取值范围1~65536

9. **total_block**（总块数）：上传或下载的总块数

10. **key**（密钥）：<字符串类型>

11. **token**（令牌）：<字符串类型>，令牌通过授权获取。

### c）JSON部分的数据字段
所有其他非保留字段。

### d）二进制内容
用于存储文件或文件块。


## 4. 状态码
### a）成功状态码
- 200：成功（OK）

### b）错误状态码
- 400：缺少必选字段。
- 401：登录密码错误。
- 402：密钥（key）已存在。
- 403：无令牌（token）或令牌错误。
- 404：未找到指定密钥（key）。
- 405：块索引（block_index）超过最大块数。
- 406：上传数据大小与要求的块大小（block_size）不匹配。
- 407：方向（direction）错误。
- 408：操作（operation）错误。
- 409：类型（type）不被允许。
- 410：缺少字段。


## 参考文献
[1] 诺丁汉（Nottingham, M.），《HTTP语义》（"HTTP Semantics"），2022年。  
[2] 菲尔丁（Fielding, Roy）等，《RFC2616：超文本传输协议——HTTP/1.1》（"RFC2616: Hypertext Transfer Protocol--HTTP/1.1"），1999年。